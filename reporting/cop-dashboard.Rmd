---
title: "Data Science Community of Practice"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    source_code: https://github.com/bcgov/bcgov-data-science-cop/blob/master/reporting/cop-dashboard.Rmd
---

<!--
Copyright 2020 Province of British Columbia

This work is licensed under the Creative Commons Attribution 4.0 International License.
To view a copy of this license, visit http://creativecommons.org/licenses/by/4.0/.
-->


```{r setup, include=FALSE}
## libraries
library(flexdashboard)
library(readr)
library(janitor)
library(lubridate)
library(dplyr)
library(tidyr)
library(ggplot2)
library(waffle)
library(RColorBrewer)
library(plotly)

## paths LAN
# if(.Platform$OS.type == "windows"){
#   lan_data_dir <- "//SFP.idir.bcgov/S177/S7792/Operations/Data Science and Analytics/7. Data Science CoP/data"
# }
# 
# ## Note: the file share must be mounted on your local filesystem
# if(.Platform$OS.type == "unix"){
#   ## Macbook path
#   lan_data_dir <- "/Volumes/Operations/Data Science and Analytics/7. Data Science CoP/data"
# }

## path no LAN
lan_data_dir <- paste0(here::here(), "/reporting/data")

## load data
event_participation <-
  read_csv(file.path(lan_data_dir, "cop-data-events.csv"),
           col_types = c("ccddDccdc")) %>%
  clean_names()

participation_by_ministry <-
  read_csv(file.path(lan_data_dir, "cop-data-part-ministries.csv"),
           col_types = c("cDdcc")) %>%
  clean_names()

workshop_feedback <-  read_csv(file.path(lan_data_dir, "cop-training-survey-feedback.csv"),
           col_types = c("ccdDccddddddddddddcc")) %>%
  clean_names()
```


Participation
======================================================================


Row 
-----------------------------------------------------------------------


### Number of Events (All Time) {.value-box}

```{r}
#number of cop events
valueBox(value = event_participation %>% 
  count(), icon = "fa-calendar")
```

### Total Attendance (All Time) {.value-box}

```{r}
#cumulative event attendance
participation_count <- event_participation %>%
  filter(date < today()) %>%
  select(date, event_title, event_type, in_person_participants, on_line_participants) %>%
  mutate(on_line_participants = replace_na(on_line_participants, 0),
         in_person_participants = replace_na(in_person_participants, 0),
         participants = in_person_participants + on_line_participants)

valueBox(value = participation_count %>% 
  summarise(sum(participants)), icon = "fa-users")
```

### Geographic Locations {.value-box}

```{r}
#number of locations
num_locations <- event_participation %>% 
  distinct(location) %>% 
  filter(location != "remote") %>% 
  count()
 
valueBox(value = num_locations, icon = "fa-globe")
```

### Number of Ministries Represented (All Time) {.value-box}

```{r}
#number of ministries
valueBox(value = participation_by_ministry %>% 
  distinct(ministry) %>% 
  count(), icon = "fa-building")
```


Row 
-----------------------------------------------------------------------


### Number of Events by Year

```{r}
#number of events by year and event type
event_sum <- participation_count %>%
  mutate(year = year(date)) %>% 
  mutate(event_type = recode(event_type, social = "meet-up")) %>% 
  group_by(year, event_type) %>% 
  count()

#event colours
event_colours = c("meet-up" = "#1f78b4",
                  "webinar" = "#ff7f00",
                  "workshop" = "#33a02c")

#event bar chart theme
theme_bar <- theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    axis.line = element_line(),
    axis.text = element_text(size = 11),
    legend.position = "top",
    legend.direction = "horizontal",
    legend.text = element_text(size = 11))

#bar chart of number of events
ggplot(data = event_sum, aes(year, n)) +
  geom_rect(
    aes(
      xmin = 2020 - 0.45,
      xmax = 2020 + 0.45,
      ymin = 0,
      ymax = 15
    ),
    alpha = 0.1,
    fill = "grey90"
  ) +
  geom_col(aes(fill = event_type), alpha = 0.6) +
  labs(
    x = NULL,
    y = NULL
  ) +
  geom_text(aes(x = 2020, y = 14.4,
                label = "2020 Goal"),
            size = 4, colour = "grey20") +
  scale_y_continuous(expand = c(0, 0),
                     limits = c(0, 15),
                     breaks = seq(0, 15, 3)) +
  scale_fill_manual(name = NULL,
                    values = event_colours) +
  theme_minimal() +
  theme_bar
```

### Locations of In-Person Events

```{r}
#get cities from bcmaps
cities <- bcmaps::bc_cities(class = "sf") %>% 
  filter(NAME %in% c("Vancouver", "Victoria", "Prince George"))

#join cities to event data
event_locations <- event_participation %>% 
  select(location) %>% 
  group_by(location) %>% 
  count() %>% 
  ungroup() %>% 
  left_join(cities, by = c("location" = "NAME")) %>% 
  # mutate(location = recode(location, "Prince George" = "Prince\nGeorge")) %>% 
  sf::st_as_sf()

#plot in-person event locations
ggplot(data = event_locations) +
  geom_sf(data = bcmaps::bc_bound(class = "sf"), fill = "white") +
  geom_sf(colour = "#33a02c", size = 3) +
  geom_sf_text(aes(label = location),
               vjust = 1.8, hjust = -.01,
               size = 3.5, colour = "grey40") +
  # coord_sf(datum = NA) +
  labs(x = NULL, y = NULL) +
  theme_minimal() +
  theme(legend.position = "none")
```


Row
-----------------------------------------------------------------------


### Event Attendance by Year

```{r}
#participation by year and event
participation_sum <- participation_count %>%
  mutate(year = year(date)) %>% 
  mutate(event_type = recode(event_type, social = "meet-up")) %>% 
  group_by(year, event_type) %>% 
  summarise(total_part = sum(participants),
            total_event = length(event_type)) 

#total events & participants per year
event_sum <- participation_sum %>% 
  group_by(year) %>% 
  summarise(num_events = sum(total_event),
            total_part = sum(total_part))

#bar chart of number of participants
ggplot(data = participation_sum, aes(year, total_part)) +
  geom_rect(
    aes(
      xmin = 2020 - 0.45,
      xmax = 2020 + 0.45,
      ymin = 0,
      ymax = 400
    ),
    alpha = 0.1,
    fill = "grey90"
  ) +
  geom_col(aes(fill = event_type), alpha = 0.6) +
  labs(
    x = NULL,
    y = NULL
  ) +
  geom_text(aes(x = 2020, y = 385,
                label = "2020 Goal"),
            size = 4, colour = "grey20") +
  scale_y_continuous(expand = c(0, 0),
                     limits = c(0, 400),
                     breaks = seq(0, 400, 50)) +
  scale_fill_manual(name = NULL,
                    values = event_colours) +
  theme_minimal() +
  theme_bar
```

### Attendance by Ministry

```{r}
#number of participants by Ministry
num_by_min <- participation_by_ministry %>% 
  select(number_participants) %>% 
  sum()

#waffle colour palette
colour_count_waffle <-  length(unique(participation_by_ministry$ministry))
get_palette_waffle <-  colorRampPalette(brewer.pal(12, "Paired"))

#waffle plot
participation_by_ministry %>%
  group_by(ministry) %>%
  summarise(count = sum(number_participants)) %>%
  ggplot(aes(fill = ministry, values = count)) +
  geom_waffle(rows = 9) +
  scale_fill_manual(values = get_palette_waffle(colour_count_waffle),
                    name = NULL) +
  coord_equal() +
  theme_enhance_waffle() +
  theme_void() +
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 8)) +
  guides(fill = guide_legend(ncol = 2, bycol = TRUE))
```


Training Events
======================================================================


Row
-----------------------------------------------------------------------


### Number of Training Events (Total All Time) {.value-box}

```{r}
# number of workshops + webinars delivered all time
valueBox(value = event_participation %>% 
  filter(event_type %in% c("workshop", "webinar")) %>% 
  count(), icon = "fa-calendar")
```

### Number of Training Attendees (Total All Time) {.value-box}

```{r}
#number of workshop+webinars attendees all time
valueBox(value = participation_count %>% 
  filter(event_type %in% c("workshop", "webinar")) %>% 
  summarise(sum(participants)), icon = "fa-users")
```


Row
-----------------------------------------------------------------------


### Workshops (Total All Time) {.value-box}

```{r}
# number of workshops delivered all time
valueBox(value = event_participation %>% 
  filter(event_type == "workshop") %>% 
  count(), icon = "fa-building")
```

### Webinars (Total All Time) {.value-box}

```{r}
# number of webinars delivered all time
valueBox(value = event_participation %>% 
  filter(event_type == "webinar") %>% 
  count(), icon = "fa-video")
```

### Workshop Training Attendees (Total All Time) {.value-box}

```{r}
#number of workshop attendees all time
valueBox(value = participation_count %>% 
  filter(event_type == "workshop") %>% 
  summarise(sum(participants)), icon = "fa-user")
```

### Webinar Training Attendees (Total All Time) {.value-box}

```{r}
#number of webinar attendees all time
valueBox(value = participation_count %>% 
  filter(event_type == "webinar") %>% 
  summarise(sum(participants)), icon = "fa-user")
```


Row
-----------------------------------------------------------------------


### Number of Training Events by Year

```{r}
#number of events by year and event type
training_sum <- participation_count %>%
  mutate(year = year(date)) %>% 
  filter(event_type %in% c("workshop", "webinar")) %>% 
  group_by(year, event_type) %>% 
  count()


#bar chart of number of events
ggplot(data = training_sum, aes(year, n)) +
  geom_rect(
    aes(
      xmin = 2020 - 0.45,
      xmax = 2020 + 0.45,
      ymin = 0,
      ymax = 6
    ),
    alpha = 0.1,
    fill = "grey90"
  ) +
  geom_col(aes(fill = event_type), alpha = 0.6) +
  labs(
    x = NULL,
    y = NULL
  ) +
  geom_text(aes(x = 2020, y = 5.6,
                label = "2020 Goal"),
            size = 4, colour = "grey20") +
  scale_y_continuous(expand = c(0, 0),
                     limits = c(0, 6),
                     breaks = seq(0, 6, 2)) +
  scale_fill_manual(name = NULL,
                    values = event_colours) +
  theme_minimal() +
  theme_bar
```

### Training Attendance by Event (Number Offerings)

```{r}
#event horizontal bar chart theme
theme_bar_horiz <- theme(
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.grid.minor.x = element_blank(),
    axis.line = element_line(),
    axis.text = element_text(size = 11),
    legend.position = "top",
    legend.direction = "horizontal",
    legend.text = element_text(size = 11))

#number participants by topic
participation_count %>%
  filter(event_type %in% c("workshop", "webinar")) %>% 
  group_by(event_title, event_type) %>% 
  summarise(total_trained = sum(participants),
            no_times_offered = n()) %>% 
  ggplot(aes(total_trained, event_title)) +
  geom_col(aes(fill = event_type), alpha = 0.6) +
  scale_fill_manual(name = NULL,
                    values = event_colours) +
  geom_text(aes(label = paste0("(", no_times_offered, ")")),
            nudge_x = 5, colour = "grey30", size = 4) +
  labs(x = NULL, y = NULL) +
  scale_x_continuous(expand = c(0, 0),
                     limits = c(0, 130),
                     breaks = seq(0, 120, 20)) +
  theme_minimal() +
  theme_bar_horiz
```


Workshop Evaluations
======================================================================


Row
-----------------------------------------------------------------------


### Overall  Evaluation: Participant Rating of Excellent + Very Good (Avg All Workshops)

```{r}
#percent excellent + very good overall assessment scores (averaged across workshops)
metric_overall <- workshop_feedback %>% 
  mutate(metric = overall_assessment_excellent_percent + overall_assessment_very_good_percent) %>% 
  select(metric) %>% 
  summarise(percent = mean(metric, na.rm =TRUE)) %>% 
  mutate(percent = paste0(percent, "%")) %>%
  pull()

gauge(metric_overall, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(80, 100), warning = c(40, 79), danger = c(0, 39)
))

# valueBox(value = metric_overall, icon = "fa-comments",
#          caption = "Excellent or Very Good Overall Rating (All Workshops)")
```

### Organization Evaluation: Participant Rating of Excellent + Very Good (Avg All Workshops)

```{r}
#percent excellent + very good organisation assessment scores (averaged across workshops)
metric_organization <- workshop_feedback %>% 
  mutate(metric = organization_assessment_excellent_percent + organization_assessment_very_good_percent) %>% 
  select(metric) %>% 
  summarise(percent = mean(metric, na.rm =TRUE)) %>% 
  mutate(percent = paste0(percent, "%")) %>% 
  pull()

gauge(metric_organization, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(80, 100), warning = c(40, 79), danger = c(0, 39)
))

# valueBox(value = metric_organization, icon = "fa-commenting-o",
#          caption = "Excellent or Very Good Organization Rating (All Workshops)")
```


Row
-----------------------------------------------------------------------


### Participant Assessments: Overall Rating by Workshop

```{r}
tidy_feedback <- workshop_feedback %>%
  pivot_longer(cols = starts_with(c("overall", "organization")),
               names_to = "category",
               values_to = "percent") %>%
  select(event_title, category, percent) %>% 
  mutate(cat_label = stringr::str_remove_all(category, "(overall|organization)_assessment_"),
         cat_label = stringr::str_remove(cat_label, "_percent"),
         cat_label = stringr::str_replace(cat_label, "_", " "),
         cat_label = factor(cat_label, levels = c("excellent",
                                                  "very good",
                                                  "good",
                                                  "fair",
                                                  "poor")))

#colour palette
colour_count <-  length(unique(tidy_feedback$cat_label))
get_palette <-  colorRampPalette(brewer.pal(9, "YlGn")[2:9])

# colour_palette <- c("poor" = "pink",
#                     "fair" = "red",
#                     "good" = "green",
#                     "very good" = "blue",
#                     "excellent" = "black")

p <- tidy_feedback %>% 
  drop_na() %>% 
  filter(stringr::str_starts(category, "overall")) %>% 
  group_by(event_title, cat_label) %>% 
  summarise(avg_percent = mean(percent)) %>% 
  ggplot(aes(avg_percent, event_title, fill = cat_label)) +
  geom_col(alpha = 0.6) +
  scale_x_continuous(expand = c(0, 0),
                     limits = c(0, 110),
                     breaks = seq(0, 100, 20)) +
  scale_fill_manual(values = rev(get_palette(colour_count)),
                    name = NULL,
                    guide = guide_legend(reverse = TRUE),
                    na.value = "black") +
  labs(x = NULL, y = NULL) +
  theme_minimal() +
  theme_bar_horiz
p

# ggplotly(p)
```

### Participant Assessments: Organization Rating by Workshop

```{r}
tidy_feedback %>% 
  drop_na() %>% 
  filter(stringr::str_starts(category, "organization")) %>% 
  group_by(event_title, cat_label) %>% 
  summarise(avg_percent = mean(percent)) %>% 
  ggplot(aes(avg_percent, event_title, fill = cat_label)) +
  geom_col(alpha = 0.6) +
  scale_x_continuous(expand = c(0, 0),
                     limits = c(0, 110),
                     breaks = seq(0, 100, 20)) +
  scale_fill_manual(values = rev(get_palette(colour_count)),
                    name = NULL,
                    guide = guide_legend(reverse = TRUE),
                    na.value = "black") +
  labs(x = NULL, y = NULL) +
  theme_minimal() +
  theme_bar_horiz
```


Explore Past Events
======================================================================


Row {data-height="900"}
-----------------------------------------------------------------------

```{r, fig.align='center'}
library(reactable)
library(htmltools)

participation_count %>%
  select(event_type, date, event_title, participants) %>%
  arrange(desc(date)) %>% 
  reactable(columns = list(
  event_type = colDef(name = "Event Type",
                      footer = "Total"
                      ),
  date = colDef(name = "Date"),
  event_title = colDef(name = "Event"),
  participants = colDef(name = "Number of Participants",
                        align = "center",
                        footer = function(values) sum(values),
                        filterable = FALSE)),
  defaultColDef = colDef(footerStyle = list(fontWeight = "bold")),
filterable = TRUE,
# minRows = 10,
# defaultPageSize = 10,
width = "100%",
height = "100%", 
# pagination = FALSE,
showPageSizeOptions = TRUE,
pageSizeOptions = c(6, 12, 24),
defaultPageSize = 6,
minRows = 6,
# fullWidth = FALSE,
highlight = TRUE,
striped = TRUE)
```



About
======================================================================


Row {data-height=300}
-----------------------------------------------------------------------


```{r, fig.width=3, fig.height=2}
knitr::include_graphics("data/cop-logo-updated.png") 
```

The **Data Science Community of Practice (CoP)** was launched in August 2018 as a venue for data science enthusiasts across the B.C. government to connect, communicate, share and learn about data science. The community exists online&mdash;and sometimes in-person&mdash;with a focus on sharing practices, inspiring each other and supporting continuous learning in data science in the BC Public Service.  
&nbsp;\
• **Join** the Data Science Community of Practice online in [bcgov Yammer](https://www.yammer.com/gov.bc.ca/#/threads/inGroup?type=in_group&feedId=5334748&view=all) and [MS Teams](https://teams.microsoft.com/l/team/19%3ab854478e8ff6436397e1cfa477422033%40thread.tacv2/conversations?groupId=a3bf276d-80e4-43c5-9387-3364248651ac&tenantId=6fdb5200-3d0d-4a8a-b036-d3685e359adc)  
• **Read** blog posts about past & future Data Science Community of Practice events [here](https://gww.gov.bc.ca/groups/data-science-community-practice)   
• **Find** Data Science Community of Practice materials & resources [here](https://github.com/bcgov/bcgov-data-science-cop)  




 
